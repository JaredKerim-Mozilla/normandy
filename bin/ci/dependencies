#!/usr/bin/env bash
set -eu

# Install latest firefox, and remove firefox-mozilla-build, which diverts
# the Firefox binary to an old version.
sudo apt-get update
sudo apt-get install firefox
sudo apt-get remove firefox-mozilla-build

# store version info in app directory, for Docker to pick up
printf '{"commit":"%s","version":"%s","source":"https://github.com/%s/%s","build":"%s"}\n' \
  "$CIRCLE_SHA1" \
  "$CIRCLE_TAG" \
  "$CIRCLE_PROJECT_USERNAME" \
  "$CIRCLE_PROJECT_REPONAME" \
  "$CIRCLE_BUILD_URL" \
  > version.json

# build image
docker build -t mozilla/normandy:latest .

# pull other docker images used below
docker pull giorgos/takis

# get MaxMind GeoIP database for tests
./bin/download_geolite2.sh
